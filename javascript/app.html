<!DOCTYPE html>
<html>
<head>
    <title>Tonejs Midi to Arduino</title>
    <script type="text/javascript" src="https://unpkg.com/tone@latest/build/Tone.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@tonejs/midi"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/clike/clike.min.js"></script>
</head>
<body>
    <style type="text/css">
        #FileDrop {
            position: relative;
            width: 100%;
            height: 100px;
            border: 2px dashed black;
            color: black;
            margin: 20px auto;
        }

        #FileDrop.Hover {
            background-color: black;
            color: white;
        }

        #FileDrop input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            left: 0px;
            top: 0px;
        }

        #FileDrop #Text {
            position: absolute;
            width: 100%;
            height: 20px;
            line-height: 20px;
            left: 0px;
            top: 50%;
            transform: translate(0, -50%);
            text-align: center;
        }

        textarea {
            font-family: monospace;
            height: 300px;
            width: 100%;
            display: inline-block;
            position: relative;
            float: left;
        }

        #Results {
            position: relative;
            width: 100%;
            margin: 10px auto;
        }

        #Description {
            position: relative;
            width: 100%;
            text-align: center;
            height: 40px;
            font-size: 16px;
            margin: 10px auto;
            font-family: sans-serif;
        }

        #PlayButton, #DownloadButton {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
    <div id="Description">
        Convert a MIDI file to Arduino tone code.
    </div>
    <div id="FileDrop">
        <div id="Text">Drop a midi file here</div>
        <input type="file" accept="audio/midi" />
    </div>
    <div id="Results">
        <textarea id="ResultsText" placeholder="Arduino code output..."></textarea>
    </div>
    <button id="PlayButton" disabled>Play MIDI</button>
    <button id="DownloadButton" disabled>Download .ino</button>

    <script type="text/javascript">
        var myTextarea = document.getElementById("ResultsText");

        // Initialize CodeMirror instance
        var editor = CodeMirror.fromTextArea(myTextarea, {
            mode: "text/x-c++src",
            lineNumbers: true,
            theme: "default",
            lineWrapping: true
        });

        if (!(window.File && window.FileReader && window.FileList && window.Blob)) {
            document.querySelector("#FileDrop #Text").textContent = "Reading files not supported by this browser";
        } else {
            const fileDrop = document.querySelector("#FileDrop");

            fileDrop.addEventListener("dragenter", () => fileDrop.classList.add("Hover"));

            fileDrop.addEventListener("dragleave", () => fileDrop.classList.remove("Hover"));

            fileDrop.addEventListener("drop", () => fileDrop.classList.remove("Hover"));

            document.querySelector("#FileDrop input").addEventListener("change", (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    const file = files[0];
                    document.querySelector("#FileDrop #Text").textContent = file.name;
                    parseFile(file);
                }
            });
        }

        let currentMidi = null;
        let synths = [];
        let playing = false;
        let midiFileName = "";

        function parseFile(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const midi = new Midi(e.target.result);
                midiFileName = file.name.split('.').slice(0, -1).join('.') + ".ino";
                editor.setValue(generateArduinoCode(midi));
                document.querySelector("#PlayButton").removeAttribute("disabled");
                document.querySelector("#DownloadButton").removeAttribute("disabled");
                currentMidi = midi;
            };
            reader.readAsArrayBuffer(file);
        }

        function generateArduinoCode(midi) {
            let arduinoCode = `
void song(int buzzerPin) {
`;

            midi.tracks.forEach(track => {
                track.notes.forEach(note => {
                    const frequency = Tone.Frequency(note.name).toFrequency();
                    const duration = Math.round(note.duration * 1000);
                    arduinoCode += `
  tone(buzzerPin, ${Math.round(frequency)});
  delay(${duration});
  noTone(buzzerPin);
`;
                });
            });

            arduinoCode += `
}

void setup() {
  song(11);  // Change the pin number as needed
}

void loop() {
  // Empty loop
}
`;
            return arduinoCode;
        }

        document.querySelector("#PlayButton").addEventListener("click", () => {
            if (playing) {
                // Stop playing
                synths.forEach(synth => synth.disconnect());
                synths = [];
                document.querySelector("#PlayButton").textContent = "Play MIDI";
                playing = false;
            } else {
                // Start playing
                if (currentMidi) {
                    const now = Tone.now() + 0.5;
                    currentMidi.tracks.forEach((track) => {
                        const synth = new Tone.PolySynth(Tone.Synth, {
                            envelope: {
                                attack: 0.02,
                                decay: 0.1,
                                sustain: 0.3,
                                release: 1,
                            },
                        }).toDestination();
                        synths.push(synth);
                        track.notes.forEach((note) => {
                            synth.triggerAttackRelease(note.name, note.duration, note.time + now, note.velocity);
                        });
                    });
                    document.querySelector("#PlayButton").textContent = "Stop MIDI";
                    playing = true;
                }
            }
        });

        document.querySelector("#DownloadButton").addEventListener("click", () => {
            const textToSave = editor.getValue();
            const blob = new Blob([textToSave], { type: "text/plain" });
            const link = document.createElement("a");
            link.download = midiFileName;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
        });

        // Disable download button if textarea is empty
        editor.on("change", () => {
            const code = editor.getValue();
            if (code.trim() === "") {
                document.querySelector("#DownloadButton").setAttribute("disabled", "true");
            } else {
                document.querySelector("#DownloadButton").removeAttribute("disabled");
            }
        });
    </script>
</body>
</html>
